name: Generate Pull Request Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate_description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-generativeai requests

      - name: Get PR data
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git log --pretty=format:"%s" origin/${{ github.event.pull_request.base.ref }}...HEAD > commits.txt || echo "No commits" > commits.txt
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD | head -c 30000 > diff.txt || echo "No diff" > diff.txt

      - name: Generate and update PR description
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import sys
          import traceback
          import google.generativeai as genai
          import requests

          print("=== Starting PR Description Generation ===")

          # Verify API key
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key or api_key == "":
              print("âœ— GEMINI_API_KEY is not set!")
              sys.exit(1)
          print(f"âœ“ API Key found (length: {len(api_key)})")

          # Configure Gemini
          try:
              genai.configure(api_key=api_key)
              print("âœ“ Gemini configured")
          except Exception as e:
              print(f"âœ— Failed to configure Gemini: {e}")
              sys.exit(1)

          # List available models
          try:
              available_models = [m.name for m in genai.list_models()]
              print(f"âœ“ Available models: {available_models[:5]}")
          except Exception as e:
              print(f"âš  Could not list models: {e}")

          # Try models in order (with correct names)
          model = None
          models_to_try = [
              'models/gemini-1.5-flash-latest',
              'models/gemini-1.5-pro-latest', 
              'models/gemini-pro'
          ]

          for model_name in models_to_try:
              try:
                  model = genai.GenerativeModel(model_name)
                  # Test the model
                  test_response = model.generate_content("Hello", generation_config={'max_output_tokens': 10})
                  print(f"âœ“ Using model: {model_name}")
                  break
              except Exception as e:
                  print(f"âš  Model {model_name} failed: {e}")
                  continue

          if not model:
              print("âœ— No available model found!")
              sys.exit(1)

          # Read commits and diff
          try:
              with open('commits.txt', 'r', encoding='utf-8') as f:
                  commits = f.read().strip()
              with open('diff.txt', 'r', encoding='utf-8') as f:
                  diff = f.read().strip()
              print(f"âœ“ Commits length: {len(commits)}, Diff length: {len(diff)}")
          except Exception as e:
              print(f"âœ— Failed to read files: {e}")
              sys.exit(1)

          # Generate description
          prompt = f"""Analyze this Pull Request and generate a professional description:

          Commits:
          {commits[:1000]}

          Code Changes Summary:
          {diff[:5000]}

          Generate:
          1. A clear title
          2. Brief summary (2-3 sentences)
          3. Key changes (bullet points)
          4. Technical details if relevant

          Keep it concise and professional. English only."""

          description = ""
          try:
              print("ðŸ”„ Generating description...")
              response = model.generate_content(
                  prompt,
                  generation_config=genai.GenerationConfig(
                      temperature=0.7,
                      max_output_tokens=1500,
                      top_p=0.8,
                      top_k=40
                  )
              )
              
              if response and hasattr(response, 'text') and response.text:
                  description = response.text.strip()
                  print(f"âœ“ Generated description ({len(description)} chars)")
              else:
                  raise ValueError("Empty response from API")
                  
          except Exception as e:
              print(f"âš  Generation failed: {type(e).__name__}: {e}")
              traceback.print_exc()
              
              # Fallback description
              description = f"""## Pull Request

          ### Commits
          {commits if commits != "No commits" else "No commit messages available"}

          ### Changes
          This PR contains code changes. Please review the diff for details.

          ---
          *Note: Auto-generation failed. Error: {str(e)[:100]}*"""

          # Update PR
          url = f"https://api.github.com/repos/{os.environ['REPO']}/pulls/{os.environ['PR_NUMBER']}"
          headers = {
              'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
              'Accept': 'application/vnd.github+json',
              'User-Agent': 'GitHub-Actions'
          }
          data = {'body': description}

          try:
              print("ðŸ”„ Updating PR...")
              r = requests.patch(url, headers=headers, json=data, timeout=30)
              r.raise_for_status()
              print(f"âœ“ PR updated successfully! Status: {r.status_code}")
          except requests.exceptions.RequestException as e:
              print(f"âœ— Failed to update PR: {e}")
              if hasattr(e, 'response') and e.response:
                  print(f"Response: {e.response.text}")
              sys.exit(1)

          print("=== Completed Successfully ===")
          EOF
