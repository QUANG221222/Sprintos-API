name: Generate Pull Request Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate_description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install google-generativeai

      - name: Get PR data
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git log --pretty=format:"%s" origin/${{ github.event.pull_request.base.ref }}...HEAD > commits.txt
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD | head -c 50000 > diff.txt

      - name: Generate description
        run: |
          cat > gen.py << 'EOF'
          import os, google.generativeai as genai, sys

          genai.configure(api_key=os.environ["GEMINI_API_KEY"])

          try:
              model = genai.GenerativeModel('gemini-2.0-flash-exp')
          except:
              model = genai.GenerativeModel('gemini-1.5-flash')

          commits = open('commits.txt', 'r', encoding='utf-8').read()
          diff = open('diff.txt', 'r', encoding='utf-8').read()

          prompt = f"""Generate a professional PR description in English based on:

          Commits:
          {commits}

          Changes:
          {diff}

          Include: title, brief summary, and detailed changes. No code blocks."""

          try:
              response = model.generate_content(prompt, generation_config={'temperature': 0.7, 'max_output_tokens': 2048})
              desc = response.text.strip()
              open('pr_desc.txt', 'w', encoding='utf-8').write(desc)
              print("✓ Generated description")
          except Exception as e:
              print(f"✗ Error: {e}", file=sys.stderr)
              open('pr_desc.txt', 'w').write(f"## Pull Request\n\n{commits}\n\n⚠️ Auto-generation failed")
          EOF

          python gen.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Update PR
        run: |
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
            -d "{\"body\":$(cat pr_desc.txt | python -c 'import sys, json; print(json.dumps(sys.stdin.read()))')}"
