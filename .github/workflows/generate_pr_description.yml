name: Generate Pull Request Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate_description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Get PR data
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git log --pretty=format:"%s" origin/${{ github.event.pull_request.base.ref }}...HEAD > commits.txt || echo "No commits" > commits.txt
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD | head -c 20000 > diff.txt || echo "No diff" > diff.txt

      - name: Generate and update PR description
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import sys
          import json
          import requests

          print("=== Starting PR Description Generation ===")

          # Read commits and diff
          try:
              with open('commits.txt', 'r', encoding='utf-8') as f:
                  commits = f.read().strip()
              with open('diff.txt', 'r', encoding='utf-8') as f:
                  diff = f.read().strip()
              print(f"âœ“ Commits length: {len(commits)}, Diff length: {len(diff)}")
          except Exception as e:
              print(f"âœ— Failed to read files: {e}")
              sys.exit(1)

          # Prepare prompt
          prompt = f"""Analyze this Pull Request and generate a professional description in English:

          Commits:
          {commits[:1000]}

          Code Changes Summary:
          {diff[:4000]}

          Generate:
          1. A clear title
          2. Brief summary (2-3 sentences)
          3. Key changes (bullet points)
          4. Technical details if relevant

          Keep it concise and professional."""

          # Try Gemini API with REST
          description = ""
          api_key = os.environ.get("GEMINI_API_KEY")

          # Models to try
          models = [
              'gemini-1.5-flash',
              'gemini-1.5-pro',
              'gemini-pro'
          ]

          for model_name in models:
              try:
                  print(f"ðŸ”„ Trying model: {model_name}")
                  url = f"https://generativelanguage.googleapis.com/v1beta/models/{model_name}:generateContent?key={api_key}"
                  
                  payload = {
                      "contents": [{
                          "parts": [{"text": prompt}]
                      }],
                      "generationConfig": {
                          "temperature": 0.7,
                          "maxOutputTokens": 1500,
                          "topP": 0.8,
                          "topK": 40
                      }
                  }
                  
                  headers = {'Content-Type': 'application/json'}
                  
                  r = requests.post(url, json=payload, headers=headers, timeout=60)
                  
                  if r.status_code == 200:
                      result = r.json()
                      description = result['candidates'][0]['content']['parts'][0]['text'].strip()
                      print(f"âœ“ Generated with {model_name} ({len(description)} chars)")
                      break
                  else:
                      print(f"âš  Model {model_name} failed: {r.status_code} - {r.text[:200]}")
                      
              except Exception as e:
                  print(f"âš  Model {model_name} error: {e}")
                  continue

          # Fallback if all models fail
          if not description:
              print("âš  All models failed, using fallback description")
              description = f"""## Pull Request

          ### Commits
          {commits if commits != "No commits" else "No commit messages available"}

          ### Changes
          This PR contains code changes. Please review the diff for details.

          ---
          *Note: Auto-generation failed. Please review changes manually.*"""

          # Update PR
          url = f"https://api.github.com/repos/{os.environ['REPO']}/pulls/{os.environ['PR_NUMBER']}"
          headers = {
              'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
              'Accept': 'application/vnd.github+json',
              'User-Agent': 'GitHub-Actions'
          }
          data = {'body': description}

          try:
              print("ðŸ”„ Updating PR...")
              r = requests.patch(url, headers=headers, json=data, timeout=30)
              r.raise_for_status()
              print(f"âœ“ PR updated successfully! Status: {r.status_code}")
          except requests.exceptions.RequestException as e:
              print(f"âœ— Failed to update PR: {e}")
              if hasattr(e, 'response') and e.response:
                  print(f"Response: {e.response.text}")
              sys.exit(1)

          print("=== Completed Successfully ===")
          EOF
