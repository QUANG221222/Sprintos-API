name: Generate Pull Request Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate_description:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install google-generativeai requests

      - name: Get PR data
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git log --pretty=format:"%s" origin/${{ github.event.pull_request.base.ref }}...HEAD > commits.txt || echo "No commits" > commits.txt
          git diff origin/${{ github.event.pull_request.base.ref }} HEAD | head -c 50000 > diff.txt || echo "No diff" > diff.txt

      - name: Generate and update PR description
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import google.generativeai as genai
          import json
          import requests

          # Configure Gemini
          genai.configure(api_key=os.environ["GEMINI_API_KEY"])

          # Try to use the latest model, fallback if needed
          try:
              model = genai.GenerativeModel('gemini-2.0-flash-exp')
          except:
              try:
                  model = genai.GenerativeModel('gemini-1.5-flash')
              except:
                  model = genai.GenerativeModel('gemini-pro')

          # Read commits and diff
          with open('commits.txt', 'r', encoding='utf-8') as f:
              commits = f.read().strip()

          with open('diff.txt', 'r', encoding='utf-8') as f:
              diff = f.read().strip()

          # Generate description
          prompt = f"""Generate a professional PR description in English based on:

          Commits:
          {commits}

          Code Changes:
          {diff}

          Requirements:
          - Write in English only
          - Include: PR title, brief summary, detailed changes
          - Professional tone
          - No code blocks or markdown fences
          - Concise and clear"""

          try:
              response = model.generate_content(
                  prompt,
                  generation_config={'temperature': 0.7, 'max_output_tokens': 2048}
              )
              description = response.text.strip()
              print("✓ Generated PR description successfully")
          except Exception as e:
              print(f"⚠ Generation error: {e}")
              description = f"""## Pull Request

          **Commits:**
          {commits}

          ---
          *Note: Auto-generation failed. Please review changes manually.*"""

          # Update PR via GitHub API
          url = f"https://api.github.com/repos/{os.environ['REPO']}/pulls/{os.environ['PR_NUMBER']}"
          headers = {
              'Authorization': f"token {os.environ['GITHUB_TOKEN']}",
              'Accept': 'application/vnd.github+json'
          }
          data = {'body': description}

          try:
              r = requests.patch(url, headers=headers, json=data)
              r.raise_for_status()
              print("✓ Updated PR description successfully")
          except Exception as e:
              print(f"✗ Failed to update PR: {e}")
              exit(1)
          EOF
